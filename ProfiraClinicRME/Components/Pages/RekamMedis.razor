@page "/rekam-medis/{IdApo}"
@inherits BasePage

@using System.Net.Http.Json
@using ProfiraClinic.Models
@using ProfiraClinicRME.Utils
@using Microsoft.EntityFrameworkCore
@using ProfiraClinicRME.Helpers
@using ProfiraClinicRME.Components.Layout
@using ProfiraClinicRME.Components.Section

@inject ProtectedLocalStorage LocalStore
@inject ICustomerService SvcCustomer
@inject IAppointmentService SvcAppointment
@inject IUserService SvcUser
@inject NavigationManager Nav;


<TopbarUser Route="Dashboard >> Rekam Medis"
            Title="@_title"
            ShowBack="true" />

<MudCard Class="pa-4 minh-100 rounded-lg">
    @if (_customer != null)
    {
        <MudGrid Spacing=2 Class="w-100 gap-3" Justify="Justify.FlexStart">
            <MudItem>

                <div class="border-2 justify-center align-center d-flex item-shadow" style="width: 150px; height: 150px;">
                    <MudImage Src="/images/blank_profile1.png" Class="w-100" />
                </div>
            </MudItem>
            <MudItem xs="9">
                <MudGrid Spacing=1 Class="flex-column" Style="max-width: 85%;">
                    <MudItem Class="">
                        <MudText Typo="Typo.h5" Color="MudBlazor.Color.Primary">@_customer.NamaCustomer</MudText>
                    </MudItem>
                    <MudItem Class="">
                        <MudGrid Spacing="2" Style="align-content:flex-start">
                            <MudItem>
                                <MudChip T="string">
                                    <MudText Typo="Typo.body1" Color="MudBlazor.Color.Default">
                                        @(_customer.KodeCustomer)
                                    </MudText>
                                </MudChip>
                            </MudItem>
                            <MudItem>
                                <MudChip T="string">

                                    <MudText Typo="Typo.body1" Color="MudBlazor.Color.Default">
                                        @(_jnsKelamin)
                                    </MudText>
                                </MudChip>
                            </MudItem>
                            <MudItem>
                                <MudChip T="string">
                                    <MudText Typo="Typo.body1" Color="MudBlazor.Color.Default">
                                        @(_age)
                                    </MudText>
                                </MudChip>
                            </MudItem>
                        </MudGrid>
                    </MudItem>
                    <MudItem Class="">
                        <MudChip T="string">
                            <MudText Typo="Typo.body1" Color="MudBlazor.Color.Default">
                                @(DateUtility.FormatDate(_customer.TanggalLahir))
                            </MudText>
                        </MudChip>
                    </MudItem>
                    <MudItem>
                        <MudGrid Class="flex-row">
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.h6" Color="MudBlazor.Color.Primary">Alamat Rumah</MudText>
                                <MudText Typo="Typo.body1" Color="MudBlazor.Color.Default">@_customer.AlamatDomisili</MudText>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudText Typo="Typo.h6" Color="MudBlazor.Color.Primary">Nomor KTP</MudText>
                                <MudText Typo="Typo.body1" Color="MudBlazor.Color.Default">@_customer.NIK</MudText>
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudText Typo="Typo.h6" Color="MudBlazor.Color.Primary">Nomor HP</MudText>
                                <MudText Typo="Typo.body1" Color="MudBlazor.Color.Default">@_customer.NomorHP</MudText>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.h6" Color="MudBlazor.Color.Primary">No Appointment</MudText>
                                <MudText Typo="Typo.body1" Color="MudBlazor.Color.Default">@CurrentAppointment.NomorAppointment</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudItem>
                </MudGrid>
            </MudItem>
        </MudGrid>
        <ProfiraClinicRME.Components.Menu.Menu />
    }
</MudCard>

@code {
    [Parameter]
    public string IdApo { get; set; } = "";

    [CascadingParameter(Name = "CurrentUser")]
    public CurrentUser CurrentUser { get; set; }

    [CascadingParameter(Name = "CurrentAppointment")]
    public TRMAppointment CurrentAppointment { get; set; }

    private bool _hidePosition;
    private bool _loading;
    private string infoFormat = "Showing {first_item} to {last_item} of {all_items}";
    private Customer? _customer;
    private string _age { get; set; } = "-";
    private string _jnsKelamin = "-";
    private string _prettyTglLahir = "-";
    private string tgTrx { get; set; } = "0";
    private string noTrx { get; set; } = "TRX001";
    private string _title = "";

    public RekamMedis()
    {

        _classPath = "App::Page::RekamMedis";
        LogTrace.Info("class init", path: _classPath);

    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        _customer = new Customer();

        // if (CurrentAppointment is null)
        // {
        //     var msg = "Current appointment data not valid.";
        //     LogTrace.Error(msg);
        //     Nav.NavigateTo("/dashboard",forceLoad:false);
        //     throw new Exception(msg);
        // }


        // if (CurrentUser is null || CurrentUser?.Klinik is null)
        // {
        //     var msg = "Current user data not valid.";
        //     LogTrace.Error(msg);
        //     throw new Exception(msg);
        // }

        _title = $"Rekam Medis / Doctor on Duty :  {CurrentUser.Karyawan?.NamaKaryawan ?? "-"}";

    }



    protected override async Task OnInitializedAsync()
    {
        LogTrace.Info("start", path: _classPath);

        // var resApo = SvcAppointment.GetCurrent();
        // if (resApo.Status != ServiceResultEnum.FOUND)
        // {
        //     addSnackbar("Data perawatan tidak ditemukan.", Severity.Error);
        //     return;
        // }

        ///todo: temporary inject , wait api correction
        // var apo = resApo.Data;
        // if (CurrentAppointment is null) return;


        var resCust = await SvcCustomer.GetByCodeAsync(CurrentAppointment.KodeCustomer ?? "");

        if (resCust.Status != ServiceResultEnum.FOUND)
        {
            LogTrace.Error("Customer not found.", CurrentAppointment.KodeCustomer ?? "", _classPath);
            addSnackbar("Data pasien tidak ditemukan.", Severity.Error);
            return;
        }

        _customer = resCust.Data!;
        LogTrace.Info("Customer found", _customer, _classPath);
        _jnsKelamin = UIHelper.GetJenisKelamin(_customer.JenisKelamin ?? "n/a");
        _age = DateUtility.FormatAge(_customer.TanggalLahir, DateTime.Now);

    }


    // protected override async Task OnAfterRenderAsync(bool firstrender)
    // {
    //     if (firstrender && _customer != null) {
    //         await LocalStore.SetAsync("age", _age);
    //         await LocalStore.SetAsync("name", _customer.NamaCustomer);
    //     }
    //     Layout.ChangePasien("", "");
    //     Layout.ChangeTitleAndRoute("REKAM MEDIS", "Perawatan Pasien / Doctor on Duty : dr. Fifien");
    //     Layout.ChangeShowSave(false);
    // }


}


<style>
    .table-add-form .mud-input-root {
        height: 30px !important;
        padding: 0px 10px !important;
        font-size: 12px !important;
    }

    .table-add-form .mud-input-label {
        font-size: 14px !important;
        line-height: 14px !important;
    }

    .table-add-form .mud-input-label-outlined.mud-input-label-margin-dense {
        transform: translate(12px, 10px) scale(1);
    }

    .table-add-form .mud-input-label-inputcontrol {
        top: -3px;
    }
</style>
