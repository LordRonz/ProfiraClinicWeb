@page "/dashboard"
@inherits BasePage

@using System.Net.Http.Json
@using Microsoft.EntityFrameworkCore
@using ProfiraClinic.Models.Api
@using ProfiraClinicRME.Application
@using ProfiraClinicRME.Components.Layout
@using ProfiraClinicRME.Components.Section
@using ProfiraClinicRME.Components.Table
@using ProfiraClinicRME.Helpers
@using ProfiraClinicRME.Infra
@using ProfiraClinicRME.Model
@using ProfiraClinicRME.Utils

@inject ISessionManager SesMan
@inject IUserService SvcUser
@inject NavigationManager Nav
@inject IAppointmentService SvcAppointment

<TopbarUser Route="Dasboard"
            Title="@_title" />

<MudCard Class="p-4 h-100 rounded-3 overflow-scroll">
    <Table WithAdd="false" WithFilter="false" WithPaging="false" Config="_appointmentTblConf" />
</MudCard>

@code {
    [CascadingParameter(Name = "CurrentUser")]
    public CurrentUser CurrentUser { get; set; }

    public TableConfig _appointmentTblConf { get; set; } = new TableConfig(new List<TableColumn>(), new List<object>());


    private List<TRMAppointment> _listAppointment;
    private string _title = "Appointment list on ";

    public Dashboard()
    {
        _classPath = "App::Page::Dashboard";
        LogTrace.Info("class init", path: _classPath);

        _listAppointment = [];

    }


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (CurrentUser is null || CurrentUser?.Klinik is null)
        {
            var msg = "Current user data not valid.";
            LogTrace.Error(msg);
            throw new Exception(msg);
        }
        LogTrace.Info("current user", CurrentUser, _classPath);

        _title += CurrentUser.Klinik.KETLK;


        var resApo = await SvcAppointment.GetListOnWaitAsync(CurrentUser.KodeLokasi ?? "", DateTime.Today, CurrentUser.Karyawan?.KodeKaryawan);

        var test = DateUtility.FormatDate(DateTime.Today, DateUtility.FormatMode.Date);
        // Check if status code indicates success

        if (resApo.Status == ServiceResultEnum.FOUND)
        {

            _listAppointment = resApo.Data.Items;
            List<object> tableData = [];
            var dataRow = new object();
            foreach (var item in _listAppointment)
            {
                dataRow = (object)new
                {
                    view = "/Perawatan/" + item.IDAppointment,
                    IDAppointment = item.IDAppointment,
                    MemberID = item.KodeCustomer ?? "",
                    NamaPasien = item.NamaCustomer ?? "",
                    AlamatDomisili = item.AlamatDomisili ?? "",
                    NomorHPCustomer = item.NomorHPCustomer ?? "",
                    TglLahir = DateUtility.FormatDate(item.TanggalLahir),
                    Usia = DateUtility.FormatAge(item.TanggalLahir, DateTime.Now),
                    Tindakan = UIHelper.GetStatusTindakan(item.StatusTindakan),
                    JanjiTemu = DateUtility.FormatTime(item.JamAppointment),
                    Reception = DateUtility.FormatDate(item.Reception, DateUtility.FormatMode.Time),
                };
                tableData.Add(dataRow);
            }


            LogTrace.Debug("table data", tableData, _classPath);

            _appointmentTblConf = new TableConfig(
                new List<TableColumn> {
                    new TableColumn {
                        Caption="Pilih", DataField="view", Type=ColumnType.View, CustomIcon="fa fa-hand-pointer", Action=SetCurrentAppointment
                    },
                    new TableColumn { Caption = "Janji Temu", DataField = "JanjiTemu" },
                    new TableColumn { Caption= "Jam Kedatangan", DataField  ="Reception"},
                    new TableColumn { Caption="Member ID", DataField="MemberID" },
                    new TableColumn { Caption = "Nama Pasien", DataField = "NamaPasien" },
                    new TableColumn { Caption = "Alamat", DataField = "AlamatDomisili" },
                    new TableColumn { Caption = "No. HP", DataField = "NomorHPCustomer" },
                    new TableColumn { Caption = "Tgl Lahir", DataField = "TglLahir" },
                    new TableColumn { Caption = "Usia", DataField = "Usia" },
                    new TableColumn { Caption = "Tindakan", DataField = "Tindakan" },
                },
                tableData
            );
        }
        else
        {
            // Handle API error case appropriately (e.g., display an error message)
            // For example: show a notification, log the error etc.

        }
    }



    private async Task SetCurrentAppointment(Dictionary<string, string> dct)
    {

        LogTrace.Info("init", dct, _classPath);
        string stIdApo = dct.GetValueOrDefault("IDAppointment") ?? "";
        var res = long.TryParse(stIdApo, out long idApo);

        if (!res)
        {
            addSnackbar("Data perawatan tidak ditemukan.", Severity.Error);
            return;
        }

        var apo = _listAppointment.FirstOrDefault(item => item.IDAppointment == idApo);

        if (apo is null)
        {
            addSnackbar("Data perawatan tidak ditemukan.", Severity.Error);
            return;
        }

        await SesMan.SetCurrentAppointment(apo);

        //update status tindakan
        var resSetStatus = await SvcAppointment.SetAppointmentOnProgress(apo);

        if (resSetStatus.Status != ServiceResultEnum.SUCCESS)
        {
            addSnackbar("Gagal mengupdate status tindakan.", Severity.Error);
            LogTrace.Error("Gagal mengupdate status tindakan", resSetStatus, _classPath);
            return;
        }


        Nav.NavigateTo("/rekam-medis/" + apo.IDAppointment);
        return;
    }
}
