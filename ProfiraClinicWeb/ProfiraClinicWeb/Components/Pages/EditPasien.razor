@page "/pasien/{Id}/edit"

@using System.Net.Http.Json
@using ProfiraClinic.Models.Core
@using ProfiraClinicWeb.Helpers
@using System.ComponentModel.DataAnnotations
@using ProfiraClinicWeb.Services
@using MudBlazor
@inject HttpClient httpClient
@inject CustomerApiService CustomerApiService
@inject NavigationManager NavigationManager

<MudCard Class="p-4">
    <MudCard Class="tab-header">
        <MudTabs Elevation="1" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" ActiveTabClass="active-tab" TabPanelClass="tab-panel">
            <MudTabPanel Text="Data Pasien">
                <MudForm @ref="form" Class="d-flex flex-column gap-3 table-form">
                    <MudPaper Elevation="1" Class="section">
                        <div class="section-header">
                            <MudIcon Icon="@Icons.Material.Filled.Person" />
                            <span>Data Identitas</span>
                            <small class="ml-auto">No. Rekam Medis</small>
                        </div>
                        <div class="section-body d-flex flex-column gap-3">
                            <MudTextField T="string" Label="Nama Pasien" @bind-Value="patient.NamaCustomer" Variant="Variant.Outlined" Margin="Margin.Dense" />
                            <MudRadioGroup T="string" Label="Jenis Kelamin" @bind-Value="selectedGender">
                                …
                            </MudRadioGroup>
                            <MudGrid>…</MudGrid>
                            <!-- all your “identity” inputs -->
                        </div>
                    </MudPaper>

                    @* ───────── Section: Alamat Sekarang ───────── *@
                    <MudPaper Elevation="1" Class="section">
                        <div class="section-header">
                            <MudIcon Icon="@Icons.Material.Filled.Home" />
                            <span>Alamat Sekarang</span>
                        </div>
                        <div class="section-body d-flex flex-column gap-3">
                            <MudTextField T="string" Label="Alamat" Lines="3" @bind-Value="patient.AlamatDomisili" Variant="Variant.Outlined" Margin="Margin.Dense" />
                            <MudGrid>…</MudGrid>
                            <!-- your address inputs -->
                        </div>
                    </MudPaper>
                    <MudTextField T="string" Label="Nama Pasien" @bind-Value="patient.NamaCustomer" Variant="Variant.Outlined" Margin="Margin.Dense" />

                    <!-- Gender selection -->
                    <MudRadioGroup T="string" Label="Jenis Kelamin" @bind-Value="selectedGender">
                        <MudRadio T="string" Value="@("L")" Color="MudBlazor.Color.Primary">Laki-Laki</MudRadio>
                        <MudRadio T="string" Value="@("P")">Perempuan</MudRadio>
                    </MudRadioGroup>

                    <MudGrid>
                        <MudItem xs="6">
                            <MudDatePicker Label="Tanggal Lahir" @bind-Date="date" Variant="Variant.Outlined" Margin="Margin.Dense" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="string" Label="Gol. Darah" @bind-Value="selectedBloodType" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" Margin="Margin.Dense">
                                <MudSelectItem Value="@("A")">A</MudSelectItem>
                                <MudSelectItem Value="@("B")">B</MudSelectItem>
                                <MudSelectItem Value="@("AB")">AB</MudSelectItem>
                                <MudSelectItem Value="@("O")">O</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <MudGrid>
                        <MudItem xs="6">
                            <MudSelect T="string" Label="Warga Negara" @bind-Value="selectedNationality" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" Margin="Margin.Dense">
                                <MudSelectItem Value="@("WNI")">WNI</MudSelectItem>
                                <MudSelectItem Value="@("WNA")">WNA</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudRadioGroup T="string" Label="Status Menikah" @bind-Value="selectedMaritalStatus" Variant="Variant.Outlined" Margin="Margin.Dense">
                                <MudRadio T="string" Value="@("M")" Color="MudBlazor.Color.Primary">Menikah</MudRadio>
                                <MudRadio T="string" Value="@("BM")">Belum Menikah</MudRadio>
                            </MudRadioGroup>
                        </MudItem>
                    </MudGrid>

                    <MudTextField T="string" Label="Alamat" Lines="3" @bind-Value="patient.AlamatDomisili" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    <MudTextField T="string" Label="Kota" @bind-Value="patient.KotaDomisili" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    <MudTextField T="string" Label="No. HP/WA" @bind-Value="patient.NomorHP" Variant="Variant.Outlined" Margin="Margin.Dense" />

                    <MudSelect T="string" Label="Agama" @bind-Value="selectedReligion" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" Margin="Margin.Dense">
                        <MudSelectItem Value="@("Kristen")">Kristen</MudSelectItem>
                        <MudSelectItem Value="@("Katolik")">Katolik</MudSelectItem>
                        <MudSelectItem Value="@("Islam")">Islam</MudSelectItem>
                        <MudSelectItem Value="@("Buddha")">Buddha</MudSelectItem>
                        <MudSelectItem Value="@("Hindu")">Hindu</MudSelectItem>
                        <MudSelectItem Value="@("Lain-lain")">Lain-lain</MudSelectItem>
                    </MudSelect>

                    <MudTextField T="string" Label="No. KTP/Passport" @bind-Value="patient.NIK" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    <MudTextField T="string" Label="Email" @bind-Value="patient.Email"
                                  Required="true" RequiredError="Email is required!"
                                  Validation="@(new EmailAddressAttribute() { ErrorMessage = "The email address is invalid" })" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    <MudTextField T="string" Label="Profesi" @bind-Value="patient.Profesi" Variant="Variant.Outlined" Margin="Margin.Dense" />

                    <MudSelect T="string" Label="Referensi" @bind-Value="patient.Referensi" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" Margin="Margin.Dense">
                        <MudSelectItem Value="@("Surat Kabar")">Surat Kabar</MudSelectItem>
                        <MudSelectItem Value="@("Media Sosial")">Media Sosial</MudSelectItem>
                        <MudSelectItem Value="@("Iklan")">Iklan</MudSelectItem>
                        <MudSelectItem Value="@("Kenalan")">Kenalan</MudSelectItem>
                    </MudSelect>

                    <MudTextField T="string" Label="Note" Lines="3" @bind-Value="patient.Note" Variant="Variant.Outlined" Margin="Margin.Dense" />

                    <MudCheckBox @bind-Value="patient.AKTIF" Dense="true" Color="MudBlazor.Color.Success">
                        Active
                    </MudCheckBox>

                    <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary" Class="ml-auto rounded-3" FullWidth="true" OnClick="SubmitAsync">
                        Simpan
                    </MudButton>
                </MudForm>
            </MudTabPanel>
            <MudTabPanel Text="Riwayat Awal Pasien">
                <MudForm>
                    <MudTextField T="string" Label="Riwayat Penyakit Dahulu (termasuk riwayat operasi)" Lines="3" />
                </MudForm>
            </MudTabPanel>
        </MudTabs>
    </MudCard>
</MudCard>

@code {
    [Parameter]
    public string Id { get; set; }

    // The patient model used for data binding.
    private MCustomer patient = new MCustomer();
    [CascadingParameter]
    public ProfiraClinicWeb.Components.Layout.MainLayout Layout { get; set; }

    // Local UI-bound properties.
    private DateTime? date = DateTime.Today;
    private string selectedGender = "L"; // "L" for Laki-Laki, "P" for Perempuan.
    private string selectedBloodType = "O";
    private string selectedNationality = "WNI";
    private string selectedMaritalStatus = "BM"; // "M" for Menikah, "BM" for Belum Menikah.
    private string selectedReligion = "Islam";

    MudForm form;

    // File upload handling.
    IList<IBrowserFile> files = new List<IBrowserFile>();
    private void UploadFiles(IBrowserFile file)
    {
        files.Add(file);
        // TODO: Implement file upload logic as needed.
    }

    protected override async Task OnInitializedAsync()
    {
        Layout.ChangeTitleAndRoute("Pasien", "Edit Pasien");

        // Load patient data using the API.
        var response = await CustomerApiService.GetPatientByCodeAsync(Id);
        if (response != null && response.StatusCode == 200)
        {
            patient = response.Data;
            // Map fields from the loaded patient to UI-bound properties.
            date = patient.TanggalLahir;
            selectedGender = patient.JenisKelamin ?? "L";
            selectedBloodType = patient.GolonganDarah ?? "O";
            selectedNationality = patient.WargaNegara ?? "WNI";
            // Optionally, map additional fields.
            selectedReligion = patient.Agama ?? "Islam";
        }
    }

    // Called when the "Simpan" button is clicked.
    private async Task SubmitAsync()
    {
        // Update patient model with UI-bound values.
        patient.TanggalLahir = date;
        patient.JenisKelamin = selectedGender;
        patient.GolonganDarah = selectedBloodType;
        patient.WargaNegara = selectedNationality;
        patient.Agama = selectedReligion;
        patient.StatusMember = selectedMaritalStatus; // or use another field/property if needed

        // Call the API service update method.
        var result = await CustomerApiService.UpdatePatientAsync(patient.KodeCustomer, patient);
        if (result.StatusCode == 200)
        {
            NavigationManager.NavigateTo("/pasien");
        }
        else
        {
            // Here you can display a snackbar or alert message with result.Message.
            System.Diagnostics.Debug.WriteLine(result.Message);
        }
    }
}

<style>
    .save-btn {
        background: rgba(47, 193, 71, 1);
        color: white;
        text-transform: none;
    }

        .save-btn:hover {
            background: rgba(27, 153, 41, 1);
        }

    .back-btn {
        background: rgba(156, 99, 5, 1);
        color: white;
        margin-left: 20px;
        text-transform: none;
    }

        .back-btn:hover {
            background: rgba(126, 69, 2, 1);
        }

    .table-form .mud-input-root {
        height: 30px !important;
        padding: 0px 10px !important;
        font-size: 12px !important;
    }

    .table-form .mud-input-label {
        font-size: 14px !important;
        line-height: 14px !important;
    }

    .active-tab {
        background-color: rgba(162, 238, 240, 1);
        border-top-right-radius: 20px;
        border-top-left-radius: 20px;
    }

    .tab-panel {
        border: 1px solid rgba(202, 199, 199, 1);
        border-top-right-radius: 20px;
        border-top-left-radius: 20px;
    }

    .tab-header {
        border: 1px solid rgba(202, 199, 199, 1);
        border-top: none;
        border-top-right-radius: 20px;
        border-top-left-radius: 20px;
    }

    .section {
        width: 100%;
        overflow: hidden; /* clip rounded corners */
        border-radius: 8px;
    }

    .section-header {
        display: flex;
        align-items: center;
        background-color: #a2eef0; /* your blue */
        padding: 0.75rem 1rem;
        font-weight: 500;
    }

        .section-header .mud-icon-root {
            margin-right: 0.5rem;
            font-size: 1.25rem;
        }

    .section-body {
        padding: 1rem;
    }
</style>