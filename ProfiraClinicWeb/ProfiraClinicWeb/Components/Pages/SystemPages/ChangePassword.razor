@page "/auth/change-password/{Id}"

@using System.Net.Http.Json
@using ProfiraClinic.Models.Core
@using ProfiraClinic.Models.Api
@using ProfiraClinicWeb.Services
@using MudBlazor
@inject HttpClient HttpClient
@inject AuthApiService AuthApiService
@inject UserApiService ApiService
@inject NavigationManager NavigationManager

<MudCard Class="p-4 h-100">
    <MudForm @ref="form" Class="table-form">
        <MudGrid GutterSize="3">
            <MudItem xs="12" sm="12">
                <MudTextField T="string"
                              Label="Username"
                              @bind-Value="userName"
                              Disabled="true"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" sm="12">
                <MudTextField T="string"
                              Label="Password Lama"
                              InputType="InputType.Password"
                              @bind-Value="oldPassword"
                              Variant="Variant.Outlined"
                              Required="true"
                              Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" sm="12">
                <MudTextField T="string"
                              Label="Password Baru"
                              InputType="InputType.Password"
                              @bind-Value="newPassword"
                              Variant="Variant.Outlined"
                              Required="true"
                              Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" sm="12">
                <MudTextField T="string"
                              Label="Konfirmasi Password"
                              InputType="InputType.Password"
                              @bind-Value="confirmPassword"
                              Variant="Variant.Outlined"
                              Required="true"
                              Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>

        <div class="button-bar mt-4">
            <MudStack Direction="Row" Justify="Justify.FlexEnd" Spacing="2" Class="mt-4">
                <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Secondary" OnClick="GoBack">
                    Kembali
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="MudBlazor.Color.Primary"
                           Disabled="!form.IsValid"
                           OnClick="SubmitAsync">
                    Simpan
                </MudButton>
            </MudStack>
        </div>
    </MudForm>
</MudCard>

@code {
    [Parameter]
    public string Id { get; set; }

    private MudForm form;
    private string userName;
    private string oldPassword;
    private string newPassword;
    private string confirmPassword;
    private CurrentUser user;

    [CascadingParameter]
    public ProfiraClinicWeb.Components.Layout.MainLayout Layout { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Layout.ChangeTitleAndRoute("User", "Change Password");
        userName = Id; // show the username passed in route
    }

    private void GoBack()
    {
        // NavigationManager.NavigateTo("/auth/users"); adjust route as needed
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var userResponse = await ApiService.GetCurrentUserAsync();
            user = userResponse.Data;
        }
        StateHasChanged();
    }

    private async Task SubmitAsync()
    {
        if (newPassword != confirmPassword)
        {
            // optionally use MudBlazor Snackbar for UX
            System.Diagnostics.Debug.WriteLine("Passwords do not match!");
            return;
        }

        var dto = new ChangeOwnPasswordDto
        {
            CurrentPassword = oldPassword,
            NewPassword = newPassword
        };

        System.Diagnostics.Debug.WriteLine(dto.CurrentPassword);
        System.Diagnostics.Debug.WriteLine(dto.NewPassword);

        var result = await AuthApiService.ChangePasswordAsync(dto);
        NavigationManager.NavigateTo("/login-user");
    }
}

<style>
    .button-bar {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 12px; /* space between buttons */
        flex-wrap: nowrap; /* never wrap to next line */
    }
</style>
