@page "/auth/change-password/{Id}"

@using System.Net.Http.Json
@using ProfiraClinic.Models.Core
@using ProfiraClinic.Models.Api
@using ProfiraClinicWeb.Services
@using MudBlazor
@inject HttpClient HttpClient
@inject AuthApiService AuthApiService
@inject NavigationManager NavigationManager

<MudCard Class="p-4 h-100">
    <MudForm @ref="form" Class="table-form">
        <MudGrid GutterSize="3">
            <MudItem xs="12" sm="12">
                <MudTextField T="string"
                              Label="Username"
                              @bind-Value="userName"
                              Disabled="true"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" sm="12">
                <MudTextField T="string"
                              Label="Password Baru"
                              InputType="InputType.Password"
                              @bind-Value="newPassword"
                              Variant="Variant.Outlined"
                              Required="true"
                              Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" sm="12">
                <MudTextField T="string"
                              Label="Konfirmasi Password"
                              InputType="InputType.Password"
                              @bind-Value="confirmPassword"
                              Variant="Variant.Outlined"
                              Required="true"
                              Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>

        <MudStack Direction="Row" Justify="Justify.FlexEnd" Spacing="2" Class="mt-4">
            <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Secondary" OnClick="GoBack">
                Kembali
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="MudBlazor.Color.Primary"
                       Disabled="!form.IsValid"
                       OnClick="SubmitAsync">
                Simpan
            </MudButton>
        </MudStack>
    </MudForm>
</MudCard>

@code {
    [Parameter]
    public string Id { get; set; }

    private MudForm form;
    private string userName;
    private string newPassword;
    private string confirmPassword;

    [CascadingParameter]
    public ProfiraClinicWeb.Components.Layout.MainLayout Layout { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Layout.ChangeTitleAndRoute("User", "Change Password");
        userName = Id; // show the username passed in route
    }

    private void GoBack()
    {
        // NavigationManager.NavigateTo("/auth/users"); adjust route as needed
    }

    private async Task SubmitAsync()
    {
        if (newPassword != confirmPassword)
        {
            // optionally use MudBlazor Snackbar for UX
            System.Diagnostics.Debug.WriteLine("Passwords do not match!");
            return;
        }

        var dto = new ChangeOwnPasswordDto
        {
            CurrentPassword = "", // you may ask user for old password if required
            NewPassword = newPassword
        };

        var result = await AuthApiService.ChangePasswordAsync(dto);
        NavigationManager.NavigateTo("/auth/users");
    }
}
