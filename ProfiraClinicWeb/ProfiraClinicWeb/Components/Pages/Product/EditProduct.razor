@page "/product/{Id}/edit"

@using ProfiraClinic.Models.Core
@using ProfiraClinicWeb.Services
@using MudBlazor
@inject GroupBarangApiService ApiService
@inject NavigationManager NavigationManager

<MudCard Class="p-3 h-100">
    <MudForm @ref="form" Class="table-form">
        <MudGrid GutterSize="0">
            <!-- Row 1: Nama Barang (max half width) -->
            <MudItem xs="12" sm="6">
                <MudTextField T="string"
                              Label="Nama Barang"
                              @bind-Value="groupBarang.NamaGroupBarang"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Class="mb-0" />
            </MudItem>

            <!-- Row break -->
            <MudItem xs="12" Class="p-0" />

            <!-- Row 2: Kode Group (max half width, read-only) -->
            <MudItem xs="12" sm="6">
                <MudTextField T="string"
                              Label="Kode Group"
                              @bind-Value="groupBarang.KodeGroupBarang"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Disabled="true"
                              Class="mb-0" />
            </MudItem>
        </MudGrid>

        <div class="button-bar mt-4">
            <MudButton Variant="Variant.Outlined" Color="MudBlazor.Color.Secondary" OnClick="GoBack">
                Kembali
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="MudBlazor.Color.Primary"
                       Type="Submit"
                       Disabled="!form?.IsValid ?? false"
                       OnClick="SubmitAsync">
                Simpan
            </MudButton>
        </div>
    </MudForm>
</MudCard>

@code {
    [Parameter] public string Id { get; set; } = string.Empty;

    private GroupBarang groupBarang = new();
    private MudForm? form;

    [CascadingParameter]
    public ProfiraClinicWeb.Components.Layout.MainLayout Layout { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Layout.ChangeTitleAndRoute("Group Barang", "Edit Group Barang");

        if (string.IsNullOrWhiteSpace(Id))
        {
            NavigationManager.NavigateTo("/product");
            return;
        }

        // Load existing data
        var resp = await ApiService.GetGroupBarangByCodeAsync(Id);
        if (resp.StatusCode == 0 && resp.Data is not null)
        {
            groupBarang = resp.Data;
            StateHasChanged();
        }
        else
        {
            // If not found or error, go back to list
            NavigationManager.NavigateTo("/product");
        }
    }

    private void GoBack() => NavigationManager.NavigateTo("/product");

    private async Task SubmitAsync()
    {
        // Make sure key stays consistent
        var kode = Id;

        // Optionally set system fields
        groupBarang.USRID = groupBarang.USRID ?? string.Empty;
        groupBarang.Aktif = string.IsNullOrEmpty(groupBarang.Aktif) ? "1" : groupBarang.Aktif;

        var result = await ApiService.UpdateGroupBarangAsync(kode, groupBarang);
        if (result.StatusCode < 300)
        {
            NavigationManager.NavigateTo("/product");
        }
        else
        {
            System.Diagnostics.Debug.WriteLine(result.Message);
        }
    }
}

<style>
    .button-bar {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 12px; /* space between buttons */
        flex-wrap: nowrap; /* never wrap to next line */
    }
    .table-form .mud-input-root {
        height: 30px !important;
        padding: 0 10px !important;
        font-size: 12px !important;
        margin-bottom: 0 !important;
    }

    .table-form .mud-input-label {
        font-size: 14px !important;
        line-height: 14px !important;
    }

    .table-form .mud-input-label-outlined.mud-input-label-margin-dense {
        transform: translate(12px, 10px) scale(1);
    }

    .table-form .mud-input-label-inputcontrol {
        top: -3px;
    }
</style>
